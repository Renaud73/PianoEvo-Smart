<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>PianoKid Evo - Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
/* ---------- RESET & BASE MOBILE ---------- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0a0a0e;
  color: #eee;
  font-family: 'Segoe UI', system-ui, sans-serif;
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
  touch-action: manipulation;
}

/* ---------- √âCRAN DE D√âMARRAGE ---------- */
#startScreen {
  position: fixed;
  inset: 0;
  background: #000;
  color: #0ff;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 9999;
  font-size: 1.2rem;
  text-align: center;
}

/* ---------- PARTITION VISUELLE ---------- */
#scoreStrip {
  flex-shrink: 0;
  height: 120px;
  background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
  border-bottom: 2px solid #0ff;
  position: relative;
  overflow: hidden;
  z-index: 50;
}
.staff {
  position: absolute;
  top: 30px;
  left: 0;
  right: 0;
  height: 60px;
  pointer-events: none;
}
.staff-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  background: rgba(255, 255, 255, 0.3);
}
.staff-line:nth-child(1) { top: 0; }
.staff-line:nth-child(2) { top: 15px; }
.staff-line:nth-child(3) { top: 30px; }
.staff-line:nth-child(4) { top: 45px; }
.staff-line:nth-child(5) { top: 60px; }
.treble-clef {
  position: absolute;
  left: 10px;
  top: 20px;
  font-size: 50px;
  color: #0ff;
  opacity: 0.5;
}
#scoreContainer {
  position: absolute;
  top: 30px;
  left: 70px;
  height: 60px;
  display: flex;
  align-items: center;
  transition: transform 0.3s;
}
.musical-note {
  position: relative;
  width: 30px;
  margin: 0 10px;
  flex-shrink: 0;
}
.note-head {
  position: absolute;
  left: 50%;
  top: 0;
  transform: translate(-50%, -50%) rotate(-20deg);
  width: 12px;
  height: 8px;
  background: #000;
  border-radius: 50%;
  border: 1px solid #000;
  z-index: 10;
}
.note-stem {
  position: absolute;
  width: 1.5px;
  height: 25px;
  background: #000;
  z-index: 5;
}
.ledger-line {
  position: absolute;
  left: 50%;
  top: 0;
  width: 20px;
  height: 1.5px;
  background: #eee;
  transform: translate(-50%, -50%);
}
.musical-note.active .note-head {
  background: #333;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
}
.musical-note.played .note-head {
  background: #000;
  opacity: 0.4;
}

/* ---------- TOP BAR MOBILE ---------- */
#topBar {
  flex-shrink: 0;
  height: auto;
  background: linear-gradient(180deg, #1a1a1a 0%, #111 100%);
  padding: 0.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}
#menu {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  width: 100%;
}
#modeSelect, #playBtn, #stopBtn, #microBtn, .speedBtn, #editTimingBtn {
  font-size: 1rem;
  padding: 0.6rem 1rem;
  border-radius: 8px;
  border: none;
  background: #000;
  color: #0ff;
  border: 2px solid #0ff;
  cursor: pointer;
  touch-action: manipulation;
}
#playBtn {
  background: linear-gradient(135deg, #00ff66, #00cc44);
  color: #000;
  font-weight: bold;
}
#stopBtn {
  background: linear-gradient(135deg, #ff0066, #ff3300);
  color: #fff;
  font-weight: bold;
}
#microBtn.listening {
  background: #f0f;
  color: #000;
  box-shadow: 0 0 10px #f0f;
}
#miniIndic {
  font-size: 0.8rem;
  color: #0ff;
  text-align: center;
}

/* ---------- FALL ZONE ---------- */
#fallZone {
  flex: 1;
  position: relative;
  background: #111;
  overflow: hidden;
  display: flex;
  justify-content: center;
}
#line {
  position: absolute;
  bottom: 100px;
  left: 0; right: 0;
  height: 3px;
  background: #0ff;
  box-shadow: 0 0 8px #0ff;
  z-index: 3;
}
.note {
  position: absolute;
  width: 38px;
  border-radius: 6px;
  text-align: center;
  font-weight: bold;
  top: -40px;
  font-size: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  z-index: 2;
  transform: translateX(-50%);
  padding-top: 4px;
}
.note.waiting {
  animation: pulse 0.8s infinite alternate;
}
@keyframes pulse {
  from { transform: scale(1) translateX(-50%); }
  to { transform: scale(1.1) translateX(-50%); }
}

/* ---------- PIANO MOBILE ---------- */
#pianoWrapper {
  flex-shrink: 0;
  height: 120px;
  background: #0a0a0e;
  overflow-x: auto;
  overflow-y: hidden;
  display: flex;
  justify-content: center;
}
#piano {
  position: relative;
  display: flex;
  height: 100%;
  min-width: max-content;
}
.key {
  position: relative;
  cursor: pointer;
  user-select: none;
  border-radius: 0 0 6px 6px;
  transition: transform .1s, filter .2s;
}
.key:active {
  transform: translateY(2px);
}
.key.selected {
  border: 2px solid #0ff;
  box-shadow: 0 0 15px #0ff;
}
.white {
  width: 38px;
  height: 116px;
  background: linear-gradient(to bottom, #fff 0%, #f8f8f8 50%, #ddd 100%);
  border: 1px solid #ccc;
  border-top: none;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
  z-index: 1;
}
.black {
  position: absolute;
  top: 0;
  width: 24px;
  height: 76px;
  background: linear-gradient(to bottom, #333 0%, #000 100%);
  border: 1px solid #000;
  border-top: none;
  z-index: 2;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
}
.label {
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  pointer-events: none;
  line-height: 1.2;
}
.black .label {
  color: #fff;
  bottom: 6px;
  font-size: 8px;
}
#pianoWrapper::-webkit-scrollbar {
  height: 8px;
}
#pianoWrapper::-webkit-scrollbar-track {
  background: #222;
}
#pianoWrapper::-webkit-scrollbar-thumb {
  background: #0ff;
  border-radius: 4px;
}

/* ---------- MODALS ---------- */
#noteTimingEditor, #profileModal, #microModal, #fireworks {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
.modal-box {
  background: #222;
  border: 2px solid #0ff;
  border-radius: 12px;
  padding: 1.5rem;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  color: #fff;
  text-align: center;
}
.modal-box h3 {
  color: #0ff;
  margin-bottom: 1rem;
}
.modal-box button {
  margin: 0.5rem;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 8px;
  background: #0ff;
  color: #000;
  font-weight: bold;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- √âCRAN DE D√âMARRAGE -->
<div id="startScreen">
  <h2>üéπ PianoKid Evo</h2>
  <p>Clique n'importe o√π pour activer le son</p>
</div>

<!-- PARTITION VISUELLE -->
<div id="scoreStrip">
  <div class="staff">
    <div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div>
  </div>
  <div class="treble-clef">ùÑû</div>
  <div id="scoreContainer"></div>
</div>

<!-- TOP BAR MOBILE -->
<div id="topBar">
  <div id="menu">
    <select id="modeSelect">
      <option value="">-- choisis --</option>
      <optgroup label="Cours">
        <option value="facile1">Main Droite</option>
        <option value="facile2">Main Gauche</option>
        <option value="facile3">Les 2 Mains</option>
      </optgroup>
      <optgroup label="Chansons">
        <option value="tattoo">Tattoo</option>
        <option value="pirates">Pirates des Cara√Øbes</option>
        <option value="clairDeLune">Au Clair de la Lune</option>
        <option value="faded">Faded - Alan Walker</option>
        <option value="believer">Believer - Imagine Dragons</option>
        <option value="starwars">Star Wars</option>
        <option value="elise">Lettre √† √âlise</option>
        <option value="badRomance">Bad Romance</option>
        <option value="inTheEnd">In The End</option>
        <option value="anniversaire">Joyeux Anniversaire</option>
        <option value="queen">Bohemian Rhapsody</option>
        <option value="bellaCiao">Bella Ciao</option>
      </optgroup>
      <optgroup label="Profils">
        <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
        <option value="profile_management">üë§ G√©rer Profils</option>
      </optgroup>
    </select>

    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>

    <div id="speedBox">
      <button class="speedBtn" data-ms="600">Lent</button>
      <button class="speedBtn active" data-ms="450">Normal</button>
      <button class="speedBtn" data-ms="300">Rapide</button>
    </div>

    <button id="editTimingBtn">‚úèÔ∏è Timing</button>

    <button id="microBtn">√âcouter Micro</button>
  </div>

  <div id="miniIndic">
    <span id="userInfoTop"></span>
  </div>
</div>

<!-- ZONES DE JEU -->
<div id="fallZone"><div id="line"></div></div>
<div id="pianoWrapper"><div id="piano"></div></div>

<!-- MODALS -->
<div id="noteTimingEditor" class="modal-box">
  <h3>√âditer le timing des notes</h3>
  <div id="timingList"></div>
  <div>
    <button id="saveTimingBtn">üíæ Sauvegarder</button>
    <button id="cancelTimingBtn">‚ùå Annuler</button>
  </div>
</div>

<div id="profileModal" class="modal-box">
  <h3>Gestion des Profils</h3>
  <select id="profileSelectModal" style="width: 100%; margin-bottom: 1rem;">
    <option value="">-- S√©lectionner un profil --</option>
  </select>
  <input id="createProfileInputModal" placeholder="Nouveau profil" maxlength="12" style="width: 100%; margin-bottom: 1rem;">
  <div>
    <button id="createProfileBtnModal">Cr√©er</button>
    <button id="deleteProfileBtnModal">Supprimer</button>
    <button id="closeProfileModal">Fermer</button>
  </div>
</div>

<div id="microModal" class="modal-box">
  <h3>Microphone refus√© ou indisponible</h3>
  <p>Impossible d'utiliser le micro. Mode simulation activ√©.</p>
  <button id="closeMicroModal">OK</button>
</div>

<div id="fireworks"></div>

<script>
/* ---------- PROFILS ---------- */
let currentUser = null;
const profileSelectModal = document.getElementById('profileSelectModal');
const createProfileInputModal = document.getElementById('createProfileInputModal');
const createProfileBtnModal = document.getElementById('createProfileBtnModal');
const deleteProfileBtnModal = document.getElementById('deleteProfileBtnModal');
const closeProfileModal = document.getElementById('closeProfileModal');
const profileModal = document.getElementById('profileModal');
const userInfo = document.getElementById('userInfoTop');

function saveProfiles(p){localStorage.setItem('pianoProfiles',JSON.stringify(p))}
function loadProfiles(){return JSON.parse(localStorage.getItem('pianoProfiles')||'{}')}

function updateProfileSelect(){
  const profiles = loadProfiles();
  profileSelectModal.innerHTML = '<option value="">-- S√©lectionner un profil --</option>';
  Object.keys(profiles).sort().forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    profileSelectModal.appendChild(opt);
  });
}

function selectProfile(name){
  if(!name){
    currentUser = null;
    userInfo.textContent = '';
    return;
  }
  currentUser = name;
  userInfo.textContent = `‚úì ${name}`;
  localStorage.setItem('pianoLastProfile', name);
}

function showProfileModal() {
  updateProfileSelect();
  profileModal.style.display = 'flex';
}

function hideProfileModal() {
  profileModal.style.display = 'none';
}

createProfileBtnModal.onclick = () => {
  const name = createProfileInputModal.value.trim();
  if(!name) return;
  const profiles = loadProfiles();
  if(profiles[name]){
    createProfileInputModal.value = '';
    createProfileInputModal.placeholder = 'Existe !';
    setTimeout(() => createProfileInputModal.placeholder = 'Nouveau profil', 1500);
    return;
  }
  profiles[name] = {best: 0};
  saveProfiles(profiles);
  updateProfileSelect();
  profileSelectModal.value = name;
  selectProfile(name);
  createProfileInputModal.value = '';
};

deleteProfileBtnModal.onclick = () => {
  const selectedProfile = profileSelectModal.value;
  if(!selectedProfile) return;
  if(!confirm(`Supprimer le profil "${selectedProfile}" ?`)) return;
  const profiles = loadProfiles();
  delete profiles[selectedProfile];
  saveProfiles(profiles);
  if(currentUser === selectedProfile) {
    currentUser = null;
    userInfo.textContent = '';
  }
  updateProfileSelect();
  profileSelectModal.value = '';
};

closeProfileModal.onclick = hideProfileModal;

// Initialisation des profils
(function initProfiles(){
  updateProfileSelect();
  const last = localStorage.getItem('pianoLastProfile');
  if(last){
    selectProfile(last);
  }
})();

/* ---------- CONSTANTES ---------- */
const START=36, END=96;
const NAMES=['C','','D','','E','F','','G','','A','','B'];
const SHARP_NAMES=['','C‚ôØ','D‚ôØ','','F‚ôØ','G‚ôØ','A‚ôØ','','C‚ôØ','D‚ôØ','','F‚ôØ'];
const FLAT_NAMES =['','D‚ô≠','E‚ô≠','','G‚ô≠','A‚ô≠','B‚ô≠','','D‚ô≠','E‚ô≠','','G‚ô≠'];
const NATURAL_COL=['#ff0033','','#ff6600','','#99ff66','#33aa33','','#9900ff','','#66ccff','','#cc99ff'];
function getSharpFlatColor(midiNote) {
  const naturalIndex = midiNote % 12;
  const map = { 1:NATURAL_COL[0], 3:NATURAL_COL[2], 6:NATURAL_COL[4], 8:NATURAL_COL[5], 10:NATURAL_COL[7] };
  return map[naturalIndex] || '#888';
}

const fallZone=document.getElementById('fallZone');
const piano=document.getElementById('piano');

/* ---------- CONSTRUCTION PIANO 61 TOUCHES ---------- */
for(let m=START; m<=END; m++){
  const rel = m % 12;
  const isBlack = [1,3,6,8,10].includes(rel);
  if(!isBlack){
    const k = document.createElement('div');
    k.className = 'key white';
    k.dataset.m = m;
    const lab = document.createElement('div');
    lab.className = 'label';
    lab.textContent = NAMES[rel] + (Math.floor(m / 12) - 1);
    lab.style.color = NATURAL_COL[rel];
    k.appendChild(lab);
    piano.appendChild(k);
  }
}
for(let m=START; m<=END; m++){
  const rel = m % 12;
  if([1,3,6,8,10].includes(rel)){
    const k = document.createElement('div');
    k.className = 'key black';
    k.dataset.m = m;
    const lab = document.createElement('div');
    lab.className = 'label';
    lab.innerHTML = `<span style="color: ${getSharpFlatColor(m)}">${SHARP_NAMES[rel]}</span><br><small>${FLAT_NAMES[rel]}</small>`;
    lab.style.color = '#fff';
    lab.style.fontSize = '8px';
    lab.style.bottom = '6px';
    lab.style.lineHeight = '1.2';
    k.appendChild(lab);
    const whiteKeyIndex = Array.from(piano.querySelectorAll('.white')).findIndex((_, i) => {
      let whiteCount = 0;
      for (let j = START; j <= m; j++) if (![1,3,6,8,10].includes(j % 12)) whiteCount++;
      return whiteCount === i + 1;
    });
    const whiteKey = piano.querySelectorAll('.white')[whiteKeyIndex];
    if(whiteKey){
      const whiteRect = whiteKey.getBoundingClientRect();
      const pianoRect = piano.getBoundingClientRect();
      k.style.left = (whiteRect.left - pianoRect.left - 12) + 'px';
    }
    piano.appendChild(k);
  }
}

/* ---------- PARTITIONS ---------- */
function normalizeNoteData(n) {
  if(typeof n === 'number') return { note: Math.abs(n), duration: 1, spacing: 1.0, hand: n < 60 ? 'left' : 'right' };
  if(!n.spacing) n.spacing = 1.0;
  return n;
}
const niveaux = {
  facile1: [
    {note: 60, duration: 1.0, spacing: 1.0}, // Do
    {note: 62, duration: 1.0, spacing: 1.0}, // R√©
    {note: 64, duration: 1.0, spacing: 1.0}, // Mi
    {note: 65, duration: 1.0, spacing: 1.0}, // Fa
    {note: 67, duration: 1.0, spacing: 1.0}, // Sol
    {note: 67, duration: 1.0, spacing: 1.0}, // Sol
    {note: 65, duration: 1.0, spacing: 1.0}, // Fa
    {note: 64, duration: 1.0, spacing: 1.0}, // Mi
    {note: 62, duration: 1.0, spacing: 1.0}, // R√©
    {note: 60, duration: 1.0, spacing: 1.0}  // Do
  ],
  facile2: [
    {note: 48, duration: 1.0, spacing: 1.0}, // Do (gauche)
    {note: 50, duration: 1.0, spacing: 1.0}, // R√© (gauche)
    {note: 52, duration: 1.0, spacing: 1.0}, // Mi (gauche)
    {note: 53, duration: 1.0, spacing: 1.0}, // Fa (gauche)
    {note: 55, duration: 1.0, spacing: 1.0}, // Sol (gauche)
    {note: 55, duration: 1.0, spacing: 1.0}, // Sol (gauche)
    {note: 53, duration: 1.0, spacing: 1.0}, // Fa (gauche)
    {note: 52, duration: 1.0, spacing: 1.0}, // Mi (gauche)
    {note: 50, duration: 1.0, spacing: 1.0}, // R√© (gauche)
    {note: 48, duration: 1.0, spacing: 1.0}  // Do (gauche)
  ],
  facile3: [
    {note: 60, duration: 1.0, spacing: 1.0}, // Do
    {note: 62, duration: 1.0, spacing: 1.0}, // R√©
    {note: 64, duration: 1.0, spacing: 1.0}, // Mi
    {note: 65, duration: 1.0, spacing: 1.0}, // Fa
    {note: 67, duration: 1.0, spacing: 1.0}, // Sol
    {note: 55, duration: 1.0, spacing: 1.0}, // Sol (gauche)
    {note: 53, duration: 1.0, spacing: 1.0}, // Fa (gauche)
    {note: 52, duration: 1.0, spacing: 1.0}, // Mi (gauche)
    {note: 50, duration: 1.0, spacing: 1.0}, // R√© (gauche)
    {note: 48, duration: 1.0, spacing: 1.0}  // Do (gauche)
  ]
};
const chansons={
  tattoo: [
    {note: 59, duration: 0.63, spacing: 6.38, hand: 'right'},
    {note: 44, duration: 1.88, spacing: 0.00, hand: 'left'},
    {note: 58, duration: 0.63, spacing: 0.63, hand: 'right'},
    {note: 59, duration: 0.63, spacing: 0.63, hand: 'right'},
    {note: 63, duration: 0.50, spacing: 0.13, hand: 'right'},
    {note: 58, duration: 0.63, spacing: 0.63, hand: 'right'},
    {note: 44, duration: 0.25, spacing: 0.25, hand: 'left'},
    {note: 59, duration: 0.88, spacing: 0.38, hand: 'right'},
    {note: 61, duration: 0.50, spacing: 0.38, hand: 'right'},
    {note: 63, duration: 1.38, spacing: 0.50, hand: 'right'},
    {note: 59, duration: 0.13, spacing: 0.00, hand: 'right'}
  ],
  pirates: [
    {note: 57, duration: 0.5, spacing: 0.5}, // La
    {note: 60, duration: 0.5, spacing: 0.5}, // Do
    {note: 62, duration: 1.0, spacing: 1.0}, // R√©
    {note: 62, duration: 1.0, spacing: 1.0}, // R√©
    {note: 62, duration: 0.5, spacing: 0.5}, // R√©
    {note: 63, duration: 0.5, spacing: 0.5}, // Mi
    {note: 65, duration: 1.0, spacing: 1.0}, // Fa
    {note: 65, duration: 1.0, spacing: 1.0}, // Fa
    {note: 65, duration: 0.5, spacing: 0.5}, // Fa
    {note: 67, duration: 0.5, spacing: 0.5}, // Sol
    {note: 64, duration: 1.0, spacing: 1.0}, // Mi
    {note: 64, duration: 1.0, spacing: 1.0}, // Mi
    {note: 62, duration: 0.5, spacing: 0.5}, // R√©
    {note: 60, duration: 0.5, spacing: 0.5}, // Do
    {note: 60, duration: 0.5, spacing: 0.5}, // Do
    {note: 62, duration: 1.5, spacing: 1.5}  // R√©
  ],
  faded: [
    {note: 52, duration: 2.75, spacing: 8.30, hand: 'left'},
    {note: 71, duration: 0.65, spacing: 0.05, hand: 'right'},
    {note: 67, duration: 0.65, spacing: 0.00, hand: 'right'},
    {note: 71, duration: 0.45, spacing: 0.65, hand: 'right'},
    {note: 67, duration: 0.70, spacing: 0.00, hand: 'right'},
    {note: 71, duration: 0.15, spacing: 0.70, hand: 'right'},
    {note: 67, duration: 0.70, spacing: 0.00, hand: 'right'},
    {note: 71, duration: 0.20, spacing: 0.45, hand: 'right'},
    {note: 71, duration: 0.80, spacing: 0.20, hand: 'right'},
    {note: 67, duration: 0.65, spacing: 0.00, hand: 'right'},
    {note: 76, duration: 0.70, spacing: 0.70, hand: 'right'},
    {note: 48, duration: 2.00, spacing: 0.00, hand: 'left'},
    {note: 76, duration: 0.70, spacing: 0.70, hand: 'right'},
    {note: 76, duration: 0.65, spacing: 0.65, hand: 'right'},
    {note: 74, duration: 0.65, spacing: 0.70, hand: 'right'},
    {note: 76, duration: 0.25, spacing: 0.35, hand: 'right'},
    {note: 48, duration: 0.15, spacing: 0.10, hand: 'left'},
    {note: 43, duration: 0.30, spacing: 0.25, hand: 'left'},
    {note: 71, duration: 0.65, spacing: 0.00, hand: 'right'},
    {note: 67, duration: 1.35, spacing: 0.00, hand: 'right'}
  ],
  clairDeLune: [
    {note: 60, duration: 1.0, spacing: 1.0}, {note: 60, duration: 1.0, spacing: 1.0},
    {note: 60, duration: 1.0, spacing: 1.0}, {note: 62, duration: 1.0, spacing: 1.0},
    {note: 64, duration: 2.0, spacing: 2.0}, {note: 62, duration: 2.0, spacing: 2.0},
    {note: 60, duration: 1.0, spacing: 1.0}, {note: 64, duration: 1.0, spacing: 1.0},
    {note: 62, duration: 1.0, spacing: 1.0}, {note: 62, duration: 1.0, spacing: 1.0},
    {note: 60, duration: 3.0, spacing: 3.0}
  ],
  believer: [
    {note: 58, duration: 0.5, spacing: 0.5}, {note: 58, duration: 0.5, spacing: 0.5},
    {note: 58, duration: 0.5, spacing: 0.5}, {note: 58, duration: 1.0, spacing: 1.5},
    {note: 54, duration: 0.5, spacing: 0.5}, {note: 54, duration: 0.5, spacing: 1.0},
    {note: 53, duration: 1.5, spacing: 2.0}
  ],
  starwars: [
    {note: 55, duration: 1.0, spacing: 1.0}, {note: 55, duration: 1.0, spacing: 1.0},
    {note: 55, duration: 1.0, spacing: 1.0}, {note: 51, duration: 0.7, spacing: 0.8},
    {note: 58, duration: 0.3, spacing: 0.4}, {note: 55, duration: 1.0, spacing: 1.0},
    {note: 51, duration: 0.7, spacing: 0.8}, {note: 58, duration: 0.3, spacing: 0.4},
    {note: 55, duration: 2.0, spacing: 2.5}
  ],
  elise: [
    {note: 76, duration: 0.5, spacing: 0.5}, {note: 75, duration: 0.5, spacing: 0.5},
    {note: 76, duration: 0.5, spacing: 0.5}, {note: 75, duration: 0.5, spacing: 0.5},
    {note: 76, duration: 0.5, spacing: 0.5}, {note: 71, duration: 0.5, spacing: 0.5},
    {note: 74, duration: 0.5, spacing: 0.5}, {note: 72, duration: 0.5, spacing: 0.5},
    {note: 69, duration: 1.5, spacing: 2.0}
  ],
  badRomance: [
    {note: 69, duration: 0.5, spacing: 0.5}, {note: 69, duration: 0.5, spacing: 0.5},
    {note: 69, duration: 0.5, spacing: 0.5}, {note: 69, duration: 1.0, spacing: 1.0},
    {note: 71, duration: 0.5, spacing: 0.5}, {note: 72, duration: 0.5, spacing: 0.5},
    {note: 69, duration: 1.0, spacing: 1.5}
  ],
  inTheEnd: [
    {note: 63, duration: 1.0, spacing: 1.0}, {note: 58, duration: 1.0, spacing: 2.0},
    {note: 58, duration: 1.0, spacing: 1.0}, {note: 61, duration: 1.0, spacing: 1.0},
    {note: 60, duration: 1.0, spacing: 1.0}, {note: 58, duration: 1.0, spacing: 1.0},
    {note: 56, duration: 1.0, spacing: 1.5}
  ],
  anniversaire: [
    {note: 60, duration: 0.5, spacing: 0.5}, {note: 60, duration: 0.5, spacing: 1.0},
    {note: 62, duration: 1.0, spacing: 1.0}, {note: 60, duration: 1.0, spacing: 1.0},
    {note: 65, duration: 1.0, spacing: 1.0}, {note: 64, duration: 2.0, spacing: 2.0}
  ],
  queen: [
    {note: 58, duration: 1.0, spacing: 1.0}, {note: 60, duration: 0.5, spacing: 0.5},
    {note: 61, duration: 0.5, spacing: 1.0}, {note: 63, duration: 1.0, spacing: 1.5},
    {note: 61, duration: 0.5, spacing: 0.5}, {note: 60, duration: 1.5, spacing: 2.0}
  ],
  bellaCiao: [
    {note: 57, duration: 0.5, spacing: 0.5}, {note: 60, duration: 0.5, spacing: 0.5},
    {note: 62, duration: 0.5, spacing: 0.5}, {note: 64, duration: 1.0, spacing: 1.2},
    {note: 57, duration: 0.5, spacing: 0.5}, {note: 60, duration: 0.5, spacing: 0.5},
    {note: 62, duration: 0.5, spacing: 0.5}, {note: 64, duration: 1.0, spacing: 1.5}
  ]
};

/* ---------- VARIABLES GLOBALES ---------- */
let notes = [];
let isSong = false;
let isTwoHandCourse = false;
let isPlaying = false;
let currentPartitionData = null;
let originalPartitionData = null;
let score = 0, combo = 0;

/* ---------- SYST√àME DE PARTITION ---------- */
let scoreNotes = [];
let currentScoreIndex = 0;

function buildScoreStrip(partition) {
  const container = document.getElementById('scoreContainer');
  container.innerHTML = '';
  scoreNotes = [];

  const midiToStaff = {
    36:14, 38:13, 40:12, 41:11, 43:10, 45:9, 47:8, 48:7, 50:6, 52:5, 53:4, 55:3, 57:2, 59:1, 60:0,
    62:-1, 64:-2, 65:-3, 67:-4, 69:-5, 71:-6, 72:-7, 74:-8, 76:-9, 77:-10, 79:-11, 81:-12, 83:-13, 84:-14
  };

  partition.forEach((d, i) => {
    const n = document.createElement('div');
    n.className = 'musical-note';
    const pos = midiToStaff[d.note] ?? 0;
    n.style.top = (pos * 7.5 + 30) + 'px';
    n.innerHTML = `<div class="note-head"></div><div class="note-stem" style="${pos>-4?'left:16px;bottom:0':'left:6px;top:0'}"></div>`;

    if(pos <= -8) {
      for(let j = -8; j >= pos; j -= 2) {
        n.innerHTML += `<div class="ledger-line" style="top:${j * 7.5 + 30}px"></div>`;
      }
    }
    if(pos >= 6) {
      for(let j = 6; j <= pos; j += 2) {
        n.innerHTML += `<div class="ledger-line" style="top:${j * 7.5 + 30}px"></div>`;
      }
    }

    container.appendChild(n);
    scoreNotes.push({ element: n, note: d.note });
  });
}

function updateScoreStrip(idx) {
  scoreNotes.forEach((n, i) => {
    n.element.classList.toggle('active', i === idx);
    n.element.classList.toggle('played', i < idx);
  });
  document.getElementById('scoreContainer').style.transform = `translateX(${Math.max(0, 150 - idx * 55)}px)`;
}

/* ---------- DROP NOTE ---------- */
let currentTempo=450;
function drop(noteData){
  const {note, duration, spacing, hand} = noteData;
  const k=document.querySelector(`[data-m="${note}"]`);
  if(!k)return;
  const el=document.createElement('div');
  el.className='note';
  const nameSpan=document.createElement('span');
  const noteName = NAMES[note%12]||'‚ôØ';
  const isBlackKey = [1,3,6,8,10].includes(note % 12);
  if(isBlackKey && SHARP_NAMES[note%12]){
    nameSpan.innerHTML = `${noteName}<span style="color: #000; font-size: 10px;">#</span>`;
  } else {
    nameSpan.textContent = noteName;
  }
  nameSpan.style.color='#222';
  nameSpan.style.fontSize='12px';
  nameSpan.style.fontWeight='700';
  nameSpan.style.marginTop='3px';
  el.appendChild(nameSpan);
  const noteColor = isBlackKey ? getSharpFlatColor(note) : (NATURAL_COL[note%12] || '#888');
  el.style.background = noteColor;
  const baseHeight = 36;
  const height = Math.max(18, baseHeight * duration);
  el.style.height = height + 'px';
  el.style.width = '38px';
  const pianoRect=piano.getBoundingClientRect();
  const fallRect=fallZone.getBoundingClientRect();
  const keyRect=k.getBoundingClientRect();
  const keyCenter = keyRect.left + keyRect.width/2;
  const fallLeft = fallRect.left;
  el.style.left = (keyCenter - fallLeft) + 'px';
  el.style.boxShadow=`0 0 12px 3px ${noteColor}`;
  const handInd=document.createElement('div');
  handInd.className='hand-indicator';
  handInd.textContent=isTwoHandCourse?(hand==='left'?'G':'D'):'';
  handInd.style.fontSize='8px';
  handInd.style.marginTop='2px';
  el.appendChild(handInd);
  const durInd=document.createElement('div');
  durInd.style.fontSize='7px';
  durInd.style.marginTop='1px';
  durInd.textContent=duration.toFixed(2);
  el.appendChild(durInd);
  fallZone.appendChild(el);
  const o={note,el,y:-height,ok:false,duration,spacing,hand,active:false,played:false};
  notes.push(o);
  function step(){
    const linePos=fallZone.clientHeight-100;
    const stopThreshold=linePos-height;
    if(!o.played && o.y >= stopThreshold && o.y <= stopThreshold + 8){
      o.played=true;
      if(isSong && !microListening){playNote(o.note,o.duration);}
    }
    o.y+=(600/currentTempo)*2;
    if(!o.ok && !isSong && o.y >= stopThreshold){
      o.y=stopThreshold;
      el.classList.add('waiting');
    }else{
      el.classList.remove('waiting');
    }
    el.style.top=o.y+'px';
    if(o.y>fallZone.clientHeight){
      if(!o.ok){combo=0;}
      el.remove();
      notes=notes.filter(x=>x!==o);
      return;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- S√âQUENCE ---------- */
let sequenceController=null;
let currentPartition=null;
function startSequence(partition){
  let seq;
  seq = niveaux[partition] || chansons[partition] || niveaux.facile1.map(normalizeNoteData);
  isSong = !!chansons[partition];
  isTwoHandCourse = ['facile1','facile2','facile3'].includes(partition);
  isPlaying = true;
  currentPartitionData = JSON.parse(JSON.stringify(seq));
  originalPartitionData = JSON.parse(JSON.stringify(seq));

  buildScoreStrip(seq);
  currentScoreIndex = 0;

  sequenceController={notes:seq,index:0,isActive:true,isPaused:false,timeout:null};
  playNextNote();
}
function playNextNote(){
  if(!sequenceController || !sequenceController.isActive)return;
  if(sequenceController.index>=sequenceController.notes.length){setTimeout(()=>stopBtn.onclick(),500);return;}
  if(sequenceController.isPaused){setTimeout(playNextNote,50);return;}
  const currentNote = sequenceController.notes[sequenceController.index];
  drop(currentNote);
  updateScoreStrip(sequenceController.index);
  const delay = currentTempo * currentNote.duration * (currentNote.spacing || 1.0);
  sequenceController.index++;
  if(!isSong){sequenceController.isPaused=true;}
  if(isSong && sequenceController.index<sequenceController.notes.length){sequenceController.timeout=setTimeout(playNextNote,delay);}
  else if(!isSong){sequenceController.isPaused=true;}
}

/* ---------- √âDITEUR TIMING ---------- */
const editTimingBtn = document.getElementById('editTimingBtn');
const noteTimingEditor = document.getElementById('noteTimingEditor');
const timingList = document.getElementById('timingList');
const saveTimingBtn = document.getElementById('saveTimingBtn');
const cancelTimingBtn = document.getElementById('cancelTimingBtn');
function showTimingEditor() {
  if(!currentPartitionData) { alert('Aucune partition s√©lectionn√©e !'); return; }
  timingList.innerHTML = '';
  currentPartitionData.forEach((noteData, index) => {
    const timingItem = document.createElement('div');
    timingItem.className = 'timingItem';
    const noteName = NAMES[noteData.note % 12]||'‚ôØ';
    const octave = Math.floor(noteData.note / 12) - 1;
    timingItem.innerHTML = `
      <label>Note ${index + 1}: ${noteName}${octave}</label>
      <input type="range" min="0.3" max="2.5" step="0.1" value="${noteData.spacing || 1.0}" data-index="${index}">
      <span class="timingValue">${(noteData.spacing || 1.0).toFixed(1)}x</span>
    `;
    const slider = timingItem.querySelector('input[type="range"]');
    const valueDisplay = timingItem.querySelector('.timingValue');
    slider.addEventListener('input', (e) => {
      const newValue = parseFloat(e.target.value);
      valueDisplay.textContent = newValue.toFixed(1) + 'x';
      currentPartitionData[index].spacing = newValue;
    });
    timingList.appendChild(timingItem);
  });
  noteTimingEditor.style.display = 'flex';
}
function hideTimingEditor() { noteTimingEditor.style.display = 'none'; }
function saveTimingChanges() {
  if(currentPartition && (niveaux[currentPartition] || chansons[currentPartition])) {
    const partitionRef = niveaux[currentPartition] || chansons[currentPartition];
    for(let i = 0; i < currentPartitionData.length; i++) partitionRef[i] = currentPartitionData[i];
  }
  hideTimingEditor();
}
function cancelTimingChanges() {
  currentPartitionData = JSON.parse(JSON.stringify(originalPartitionData));
  hideTimingEditor();
}
editTimingBtn.addEventListener('click', showTimingEditor);
saveTimingBtn.addEventListener('click', saveTimingChanges);
cancelTimingBtn.addEventListener('click', cancelTimingChanges);

/* ---------- CONTR√îLES ---------- */
document.getElementById('modeSelect').onchange = (e) => {
  if(e.target.value === 'profile_management') {
    showProfileModal();
    e.target.value = '';
    return;
  }
  currentPartition = e.target.value;
};
document.getElementById('playBtn').onclick=()=>{
  if(!currentPartition){alert('Choisis une partition dans le menu.');return;}
  if(sequenceController){sequenceController.isActive=false;if(sequenceController.timeout)clearTimeout(sequenceController.timeout);}
  notes.forEach(x=>x.el.remove());
  notes=[];
  score=0;
  combo=0;
  startSequence(currentPartition);
};
document.getElementById('stopBtn').onclick=()=>{
  if(sequenceController){sequenceController.isActive=false;if(sequenceController.timeout)clearTimeout(sequenceController.timeout);sequenceController=null;}
  notes.forEach(x=>x.el.remove());
  notes=[];
  isPlaying = false;
  document.getElementById('scoreContainer').innerHTML = '';
  scoreNotes = [];
  currentScoreIndex = 0;
  showCongrats();
};

/* ---------- CLAVIER TACTILE + AUDIO ---------- */
let audioCtx = null;
function initAudio() {
  if(!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}
function playSound(midiNote, duration = 0.3) {
  if(!audioCtx) initAudio();
  const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}
function handleKeyPress(m){
  playSound(m);
  flash(m);
  if(isSong){
    notes.forEach(x=>{if(!x.ok && x.note===m){x.ok=true;score++;combo++;}});
  }else{
    const waitingNotes = notes.filter(n => !n.ok);
    if(waitingNotes.length > 0){
      const linePos = fallZone.clientHeight - 100;
      let closestNote = null;
      let minDistance = Infinity;
      waitingNotes.forEach(note => {
        const noteBottom = note.y + note.el.offsetHeight;
        const distance = Math.abs(noteBottom - linePos);
        if(distance < minDistance){ minDistance = distance; closestNote = note; }
      });
      if(closestNote && closestNote.note === m){
        closestNote.ok = true;
        score++;
        combo++;
        currentScoreIndex++;
        if(currentScoreIndex < scoreNotes.length) {
          updateScoreStrip(currentScoreIndex);
        }
        if(sequenceController && sequenceController.isPaused){
          sequenceController.isPaused = false;
          setTimeout(playNextNote, 50);
        }
      }else{
        combo = 0;
      }
    }
  }
}
function flash(m){
  const k=document.querySelector(`[data-m="${m}"]`);
  if(!k)return;
  k.style.filter='brightness(1.4)';
  setTimeout(()=>k.style.filter='',150);
}
piano.addEventListener('touchstart',e=>{
  e.preventDefault();
  const k=e.target.closest('.key');
  if(!k)return;
  const m=+k.dataset.m;
  handleKeyPress(m);
});
piano.addEventListener('click',e=>{
  const k=e.target.closest('.key');
  if(!k)return;
  const m=+k.dataset.m;
  handleKeyPress(m);
});

/* ---------- SPEED ---------- */
const speedBox=document.getElementById('speedBox');
speedBox.addEventListener('click',e=>{
  const btn=e.target.closest('.speedBtn');
  if(!btn)return;
  document.querySelectorAll('.speedBtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentTempo=+btn.dataset.ms;
});

/* ---------- MICRO - ANALYSE SILENCIEUSE ---------- */
const microBtn=document.getElementById('microBtn');
const microModal=document.getElementById('microModal');
const closeMicroModal=document.getElementById('closeMicroModal');
let microListening=false,audioStream=null,microAudioContext=null,analyser=null,dataArray=null,rafId=null;

async function startSilentMicroAnalysis() {
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: false,
        sampleRate: 22050,
        channelCount: 1,
        latency: 0.02
      },
      video: false
    });

    microAudioContext = new (window.AudioContext || window.webkitAudioContext)({
      sampleRate: 22050,
      latencyHint: 'interactive'
    });

    if (microAudioContext.state === 'suspended') {
      await microAudioContext.resume();
    }

    analyser = microAudioContext.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.9;
    analyser.minDecibels = -80;
    analyser.maxDecibels = -10;

    dataArray = new Uint8Array(analyser.frequencyBinCount);

    const source = microAudioContext.createMediaStreamSource(audioStream);
    source.connect(analyser);

    microListening = true;
    microBtn.classList.add('listening');
    microBtn.textContent = 'Arr√™ter Micro';

    silentAnalysisLoop();
  } catch (err) {
    microBtn.textContent = '√âcouter Micro';
    microModal.style.display = 'flex';
  }
}

function silentAnalysisLoop() {
  if (!microListening || !analyser || !dataArray) return;

  analyser.getByteFrequencyData(dataArray);

  let totalEnergy = 0;
  let peakAmplitude = 0;
  let peakBin = 0;

  const minBin = Math.floor(80 * dataArray.length / microAudioContext.sampleRate);
  const maxBin = Math.floor(1500 * dataArray.length / microAudioContext.sampleRate);

  for (let i = minBin; i < maxBin && i < dataArray.length; i++) {
    totalEnergy += dataArray[i];
    if (dataArray[i] > peakAmplitude) {
      peakAmplitude = dataArray[i];
      peakBin = i;
    }
  }

  const avgEnergy = totalEnergy / (maxBin - minBin);
  const detectionThreshold = Math.max(60, avgEnergy * 2.5);

  if (peakAmplitude > detectionThreshold && peakAmplitude > 70) {
    const peakFrequency = (peakBin * microAudioContext.sampleRate) / (2 * dataArray.length);
    const note = Math.round(69 + 12 * Math.log2(peakFrequency / 440));

    if (note >= START && note <= END) {
      setTimeout(() => {
        if (microListening) {
          handleKeyPress(note);
        }
      }, 150);

      setTimeout(() => {
        if (microListening) {
          rafId = requestAnimationFrame(silentAnalysisLoop);
        }
      }, 300);
      return;
    }
  }

  if (microListening) {
    rafId = requestAnimationFrame(silentAnalysisLoop);
  }
}

function stopSilentAnalysis() {
  microListening = false;

  if(rafId){
    cancelAnimationFrame(rafId);
    rafId = null;
  }

  if(analyser){
    analyser.disconnect();
    analyser = null;
  }

  if(audioStream){
    audioStream.getTracks().forEach(track => track.stop());
    audioStream = null;
  }

  if(microAudioContext){
    if (microAudioContext.state !== 'closed') {
      microAudioContext.suspend();
    }
  }

  microBtn.classList.remove('listening');
  microBtn.textContent = '√âcouter Micro';
}

microBtn.addEventListener('click', async () => {
  if (microListening) {
    stopSilentAnalysis();
  } else {
    await startSilentMicroAnalysis();
  }
});

closeMicroModal.addEventListener('click',() => {
  microModal.style.display = 'none';
});

/* ---------- VRAIS FEUX D'ARTIFICE ---------- */
function showCongrats(){
  if(currentUser){
    const p=loadProfiles();
    if(score>(p[currentUser].best||0)){
      p[currentUser].best=score;
      saveProfiles(p);
    }
  }
  const fw = document.getElementById('fireworks');
  fw.style.display = 'block';
  fw.innerHTML = '';
  const colors = ['#0ff', '#ff0', '#f0f', '#0f0', '#f00', '#fff', '#fa0'];
  const particlesPerBurst = 60;
  const bursts = 5;

  for(let b = 0; b < bursts; b++){
    setTimeout(() => {
      const x = Math.random() * 100;
      const y = Math.random() * 60 + 20;
      const color = colors[Math.floor(Math.random() * colors.length)];

      for(let i = 0; i < particlesPerBurst; i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.background = color;
        p.style.left = x + '%';
        p.style.top = y + '%';
        const angle = (Math.PI * 2 * i) / particlesPerBurst;
        const dist = Math.random() * 150 + 50;
        p.style.setProperty('--dx', `${Math.cos(angle) * dist}px`);
        p.style.setProperty('--dy', `${Math.sin(angle) * dist}px`);
        p.style.animationDelay = (Math.random() * 0.2) + 's';
        fw.appendChild(p);
      }
    }, b * 300);
  }

  fw.onclick = () => {
    fw.style.display = 'none';
    fw.innerHTML = '';
    document.getElementById('modeSelect').value = '';
    currentPartition = null;
    score = 0;
    combo = 0;
  };
}

/* ---------- AUDIO CHANSONS ---------- */
let songAudioCtx=null;
function initSongAudio(){if(!songAudioCtx){songAudioCtx=new (window.AudioContext||window.webkitAudioContext)();}}
function playNote(midiNote,duration){
  if(!isPlaying||!isSong||microListening)return;
  if(!songAudioCtx)initSongAudio();
  if(songAudioCtx.state==='suspended')songAudioCtx.resume();
  const frequency=440*Math.pow(2,(midiNote-69)/12);
  const osc=songAudioCtx.createOscillator();
  const gain=songAudioCtx.createGain();
  osc.type='triangle';
  osc.frequency.value=frequency;
  const now=songAudioCtx.currentTime;
  const attack=0.01,sustain=Math.max(0.1,duration*0.7),release=Math.max(0.05,duration*0.3);
  gain.gain.setValueAtTime(0,now);
  gain.gain.linearRampToValueAtTime(0.4,now+attack);
  gain.gain.exponentialRampToValueAtTime(0.2,now+attack+sustain);
  gain.gain.exponentialRampToValueAtTime(0.001,now+attack+sustain+release);
  osc.connect(gain);
  gain.connect(songAudioCtx.destination);
  osc.start(now);
  osc.stop(now+attack+sustain+release+0.05);
}

/* ---------- ACTIVATION AUDIO ---------- */
const startScreen = document.getElementById('startScreen');
function unlockAudio() {
  if (!audioCtx) initAudio();
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  if (songAudioCtx && songAudioCtx.state === 'suspended') {
    songAudioCtx.resume();
  }
  startScreen.style.display = 'none';
  document.removeEventListener('click', unlockAudio);
  document.removeEventListener('keydown', unlockAudio);
  document.removeEventListener('touchstart', unlockAudio);
}
document.addEventListener('click', unlockAudio);
document.addEventListener('keydown', unlockAudio);
document.addEventListener('touchstart', unlockAudio);
</script>
</body>
</html>