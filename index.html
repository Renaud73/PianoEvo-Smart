<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PianoKid Evo - Mobile</title>
<style>
/* üé® VISUEL IDENTIQUE - juste ajouts tactiles */
:root{--keyW:44px; --keyH:146px; --blackW:28px; --blackH:96px;}
*{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent;}
body{height:100vh; width:100vw; background:#0a0a0e; color:#eee; font-family:'Segoe UI',system-ui,sans-serif; display:flex; flex-direction:column; overflow:hidden;}

/* üì± RESPONSIVE - SAUF VISUEL */
@media (max-width:900px){:root{--keyW:11vw; --keyH:28vh; --blackW:7vw; --blackH:18vh;}}
@media (max-width:600px){#topBar{font-size:.9rem;}}

/* ‚ÜïÔ∏è Piano scrollable */
#pianoWrapper{overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;}
#piano{display:flex; height:100%; width:max-content;}

/* üí• Emp√™che le scroll page sur les touches */
.key{touch-action:manipulation; -webkit-user-select:none; user-select:none;}

/* üéØ Gros boutons tactiles */
button,select{min-height:44px; min-width:44px; font-size:1rem;}

/* üéØ Reste identique */
#startScreen{position:fixed; inset:0; z-index:9999; background:#000; color:#0ff; display:flex; align-items:center; justify-content:center; flex-direction:column;}
#scoreStrip{flex-shrink:0; height:160px; background:linear-gradient(180deg,#2a2a2a 0%,#1a1a1a 100%); border-bottom:2px solid #0ff; position:relative; overflow:hidden;}
.staff{position:absolute; top:40px; left:0; right:0; height:80px; pointer-events:none;}
.staff-line{position:absolute; left:0; right:0; height:1.5px; background:rgba(255,255,255,.3);}
.treble-clef{position:absolute; left:20px; top:25px; font-size:80px; color:#0ff; opacity:.5;}
#scoreContainer{position:absolute; top:40px; left:100px; height:80px; display:flex; align-items:center;}
.musical-note{position:relative; width:40px; margin:0 15px; flex-shrink:0;}
.note-head{position:absolute; left:50%; top:0; transform:translate(-50%,-50%) rotate(-20deg); width:16px; height:11px; background:#000; border-radius:50%; border:1px solid #000;}
.note-stem{position:absolute; width:1.8px; height:35px; background:#000;}
.ledger-line{position:absolute; left:50%; top:0; width:26px; height:2px; background:#eee; transform:translate(-50%,-50%);}
.musical-note.active .note-head{background:#333; box-shadow:0 0 8px rgba(255,255,255,.3);}
.musical-note.played .note-head{background:#000; opacity:.4;}

#topBar{flex-shrink:0; height:60px; background:linear-gradient(180deg,#1a1a1a 0%,#111 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 20px rgba(0,255,255,.2); padding:.5rem 1rem;}
#menu{display:flex; gap:.8rem; align-items:center; flex-wrap:wrap; justify-content:center; max-width:1200px;}
#miniIndic{display:flex; gap:.8rem; font-size:.85rem; color:#0ff;}
#modeSelect{background:#000; color:#0ff; border:2px solid #0ff; padding:5px; border-radius:5px; min-width:200px;}
#playBtn{background:linear-gradient(135deg,#00ff66,#00cc44); color:#000; font-weight:bold; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;}
#stopBtn{background:linear-gradient(135deg,#ff0066,#ff3300); color:#fff; font-weight:bold; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;}
#microBtn{background:#333; color:#aaa; padding:8px; border-radius:5px; border:none; cursor:pointer;}
#microBtn.listening{background:#f0f; color:#000; box-shadow:0 0 12px #f0f;}

#fallZone{flex:1; position:relative; min-height:300px; background:#111; box-shadow:inset 0 0 20px #000; overflow:hidden; display:flex; justify-content:center;}
#line{position:absolute; bottom:120px; left:0; right:0; height:4px; background:#0ff; box-shadow:0 0 12px #0ff;}
.note{position:absolute; width:44px; border-radius:6px; text-align:center; font-weight:bold; top:-50px; font-size:18px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; z-index:2; transform:translateX(-50%); padding-top:5px;}
.note.waiting{animation:pulse .8s infinite alternate;}
@keyframes pulse{from{transform:scale(1) translateX(-50%);}to{transform:scale(1.1) translateX(-50%);}}

.white{width:var(--keyW); height:var(--keyH); background:linear-gradient(to bottom,#fff 0%,#f8f8f8 50%,#ddd 100%); border:1px solid #ccc; border-top:none; box-shadow:0 4px 10px rgba(0,0,0,.5);}
.black{position:absolute; top:0; width:var(--blackW); height:var(--blackH); background:linear-gradient(to bottom,#333 0%,#000 100%); border:1px solid #000; border-top:none; z-index:2; box-shadow:0 6px 14px rgba(0,0,0,.7);}
.label{position:absolute; bottom:10px; width:100%; text-align:center; font-size:11px; font-weight:700; pointer-events:none;}
.black .label{color:#fff !important; bottom:8px; font-size:9px;}

#noteTimingEditor{position:fixed; inset:10px; z-index:3000; background:#222; border:2px solid #0ff; border-radius:12px; padding:1rem; display:none;}
#timingList{max-height:60vh; overflow-y:auto;}
.timingItem{display:flex; align-items:center; gap:8px; margin-bottom:8px;}
#fireworks{position:fixed; inset:0; background:#000; z-index:9999; display:none;}
.particle{position:absolute; width:4px; height:4px; border-radius:50%; animation:burst 1.6s ease-out forwards;}
@keyframes burst{0%{transform:translate(0,0) scale(1); opacity:1;}100%{transform:translate(var(--dx),var(--dy)) scale(0); opacity:0;}}
</style>
</head>
<body>

<div id="startScreen"><h2>üéπ PianoKid Evo</h2><p>Tap anywhere to start</p></div>
<div id="scoreStrip"><div class="staff"><div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div><div class="staff-line"></div></div><div class="treble-clef">ùÑû</div><div id="scoreContainer"></div></div>
<div id="topBar"><div id="menu"><div id="mainMenuContainer"><select id="modeSelect">‚Ä¶</select><button id="playBtn">Play</button><button id="stopBtn">Stop</button><button id="editTimingBtn">‚úèÔ∏è</button><button id="microBtn">üé§</button></div><div id="miniIndic"><span id="userInfoTop"></span></div></div></div>
<div id="fallZone"><div id="line"></div></div>
<div id="pianoWrapper"><div id="piano"></div></div>
<div id="noteTimingEditor"><h3>√âditer le timing</h3><div id="timingList"></div><div id="timingEditorButtons"><button id="saveTimingBtn">üíæ</button><button id="cancelTimingBtn">‚ùå</button></div></div>
<div id="fireworks"></div>

<script>
/* ========== PROFILS (identique) ========== */
let currentUser = null;
const profileSelectModal = document.getElementById('profileSelectModal');
const createProfileInputModal = document.getElementById('createProfileInputModal');
const createProfileBtnModal = document.getElementById('createProfileBtnModal');
const deleteProfileBtnModal = document.getElementById('deleteProfileBtnModal');
const closeProfileModal = document.getElementById('closeProfileModal');
const profileModal = document.getElementById('profileModal');
const userInfo = document.getElementById('userInfoTop');
function saveProfiles(p){localStorage.setItem('pianoProfiles',JSON.stringify(p))}
function loadProfiles(){return JSON.parse(localStorage.getItem('pianoProfiles')||'{}')}
function updateProfileSelect(){
  const profiles = loadProfiles();
  profileSelectModal.innerHTML = '<option value="">-- S√©lectionner un profil --</option>';
  Object.keys(profiles).sort().forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
    profileSelectModal.appendChild(opt);
  });
}
function selectProfile(name){
  if(!name){currentUser = null; userInfo.textContent = ''; return;}
  currentUser = name; userInfo.textContent = `‚úì ${name}`;
  localStorage.setItem('pianoLastProfile', name);
  console.log(`Profil s√©lectionn√©: ${name}`);
}
function showProfileModal() { updateProfileSelect(); profileModal.style.display = 'flex'; }
function hideProfileModal() { profileModal.style.display = 'none'; }
createProfileBtnModal.onclick = () => {
  const name = createProfileInputModal.value.trim();
  if(!name) return;
  const profiles = loadProfiles();
  if(profiles[name]){createProfileInputModal.value='';createProfileInputModal.placeholder='Existe !';setTimeout(()=>createProfileInputModal.placeholder='Nouveau profil',1500);return;}
  profiles[name] = {best: 0}; saveProfiles(profiles); updateProfileSelect();
  profileSelectModal.value = name; selectProfile(name); createProfileInputModal.value = '';
};
deleteProfileBtnModal.onclick = () => {
  const selectedProfile = profileSelectModal.value;
  if(!selectedProfile) return;
  if(!confirm(`Supprimer le profil "${selectedProfile}" ?`)) return;
  const profiles = loadProfiles(); delete profiles[selectedProfile]; saveProfiles(profiles);
  if(currentUser === selectedProfile) {currentUser = null; userInfo.textContent = '';}
  updateProfileSelect(); profileSelectModal.value = '';
};
closeProfileModal.onclick = hideProfileModal;
(function initProfiles(){updateProfileSelect();const last=localStorage.getItem('pianoLastProfile');if(last){selectProfile(last);}})();

/* ========== AUDIO (identique) ========== */
let audioCtx = null;
function initAudio() {
  if(!audioCtx) {audioCtx = new (window.AudioContext || window.webkitAudioContext)();}
  if(audioCtx.state === 'suspended') {audioCtx.resume();}
}
function playSound(midiNote, duration = 0.3) {
  initAudio();
  const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'triangle'; osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + duration);
}

/* ========== PIANO 61 TOUCHES (identique) ========== */
const START=36, END=96;
const NAMES=['C','','D','','E','F','','G','','A','','B'];
const SHARP_NAMES=['','C‚ôØ','D‚ôØ','','F‚ôØ','G‚ôØ','A‚ôØ','','C‚ôØ','D‚ôØ','','F‚ôØ'];
const FLAT_NAMES =['','D‚ô≠','E‚ô≠','','G‚ô≠','A‚ô≠','B‚ô≠','','D‚ô≠','E‚ô≠','','G‚ô≠'];
const NATURAL_COL=['#ff0033','','#ff6600','','#99ff66','#33aa33','','#9900ff','','#66ccff','','#cc99ff'];
function getSharpFlatColor(midiNote) {
  const naturalIndex = midiNote % 12;
  const map = { 1:NATURAL_COL[0], 3:NATURAL_COL[2], 6:NATURAL_COL[4], 8:NATURAL_COL[5], 10:NATURAL_COL[7] };
  return map[naturalIndex] || '#888';
}
const fallZone=document.getElementById('fallZone');
const piano=document.getElementById('piano');
for(let m=START; m<=END; m++){
  const rel = m % 12;
  const isBlack = [1,3,6,8,10].includes(rel);
  if(!isBlack){
    const k = document.createElement('div');
    k.className = 'key white'; k.dataset.m = m;
    const lab = document.createElement('div'); lab.className = 'label';
    lab.textContent = NAMES[rel] + (Math.floor(m / 12) - 1);
    lab.style.color = NATURAL_COL[rel];
    k.appendChild(lab); piano.appendChild(k);
  }
}
for(let m=START; m<=END; m++){
  const rel = m % 12;
  if([1,3,6,8,10].includes(rel)){
    const k = document.createElement('div');
    k.className = 'key black'; k.dataset.m = m;
    const lab = document.createElement('div'); lab.className = 'label';
    lab.innerHTML = `<span style="color: ${getSharpFlatColor(m)}">${SHARP_NAMES[rel]}</span><br><small>${FLAT_NAMES[rel]}</small>`;
    lab.style.color = '#fff'; lab.style.fontSize = '9px'; lab.style.bottom = '8px'; lab.style.lineHeight = '1.2';
    k.appendChild(lab);
    const whiteKeyIndex = Array.from(piano.querySelectorAll('.white')).findIndex((_, i) => {
      let whiteCount = 0; for (let j = START; j <= m; j++) if (![1,3,6,8,10].includes(j % 12)) whiteCount++;
      return whiteCount === i + 1;
    });
    const whiteKey = piano.querySelectorAll('.white')[whiteKeyIndex];
    if(whiteKey){
      const whiteRect = whiteKey.getBoundingClientRect();
      const pianoRect = piano.getBoundingClientRect();
      k.style.left = (whiteRect.left - pianoRect.left - 14) + 'px';
    }
    piano.appendChild(k);
  }
}

/* ========== PARTITION VISUELLE (identique) ========== */
let scoreNotes = [];
let currentScoreIndex = 0;
function buildScoreStrip(partition) {
  const container = document.getElementById('scoreContainer');
  container.innerHTML = ''; scoreNotes = [];
  const midiToStaff = {36:14,38:13,40:12,41:11,43:10,45:9,47:8,48:7,50:6,52:5,53:4,55:3,57:2,59:1,60:0,62:-1,64:-2,65:-3,67:-4,69:-5,71:-6,72:-7,74:-8,76:-9,77:-10,79:-11,81:-12,83:-13,84:-14};
  partition.forEach((d, i) => {
    const n = document.createElement('div'); n.className = 'musical-note';
    const pos = midiToStaff[d.note] ?? 0; n.style.top = (pos * 10 + 40) + 'px';
    n.innerHTML = `<div class="note-head"></div><div class="note-stem" style="${pos>-4?'left:21px;bottom:0':'left:8px;top:0'}"></div>`;
    if(pos <= -8){for(let j=-8;j>=pos;j-=2)n.innerHTML+=`<div class="ledger-line" style="top:${j*10+40}px"></div>`;}
    if(pos >= 6){for(let j=6;j<=pos;j+=2)n.innerHTML+=`<div class="ledger-line" style="top:${j*10+40}px"></div>`;}
    container.appendChild(n); scoreNotes.push({ element: n, note: d.note });
  });
}
function updateScoreStrip(idx) {
  scoreNotes.forEach((n, i) => {
    n.element.classList.toggle('active', i === idx);
    n.element.classList.toggle('played', i < idx);
  });
  document.getElementById('scoreContainer').style.transform = `translateX(${Math.max(0, 200 - idx * 70)}px)`;
}

/* ========== PARTITIONS (identique) ========== */
function normalizeNoteData(n) {
  if(typeof n === 'number') return { note: Math.abs(n), duration: 1, spacing: 1.0, hand: n < 60 ? 'left' : 'right' };
  if(!n.spacing) n.spacing = 1.0; return n;
}
const niveaux = {
  facile1: [{note:60,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:64,duration:1,spacing:1},{note:65,duration:1,spacing:1},{note:67,duration:1,spacing:1}],
  facile2: [{note:48,duration:1,spacing:1},{note:50,duration:1,spacing:1},{note:52,duration:1,spacing:1},{note:53,duration:1,spacing:1},{note:55,duration:1,spacing:1}],
  facile3: [{note:60,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:64,duration:1,spacing:1},{note:65,duration:1,spacing:1},{note:67,duration:1,spacing:1},{note:48,duration:1,spacing:1},{note:50,duration:1,spacing:1},{note:52,duration:1,spacing:1}]
};
const chansons = {
  pirates: [{note:57,duration:.5,spacing:.5},{note:60,duration:.5,spacing:.5},{note:62,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:62,duration:.5,spacing:.5},{note:63,duration:.5,spacing:.5},{note:65,duration:1,spacing:1},{note:65,duration:1,spacing:1},{note:65,duration:.5,spacing:.5},{note:67,duration:.5,spacing:.5},{note:64,duration:1,spacing:1},{note:64,duration:1,spacing:1},{note:62,duration:.5,spacing:.5},{note:60,duration:.5,spacing:.5},{note:60,duration:.5,spacing:.5},{note:62,duration:1.5,spacing:1.5}],
  clairDeLune: [{note:60,duration:1,spacing:1},{note:60,duration:1,spacing:1},{note:60,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:64,duration:2,spacing:2},{note:62,duration:2,spacing:2},{note:60,duration:1,spacing:1},{note:64,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:62,duration:1,spacing:1},{note:60,duration:3,spacing:3}],
  faded: [{note:63,duration:1,spacing:1},{note:59,duration:1,spacing:1},{note:61,duration:1,spacing:1},{note:56,duration:2,spacing:2},{note:63,duration:.5,spacing:.5},{note:63,duration:.5,spacing:.5},{note:63,duration:.5,spacing:1},{note:66,duration:.5,spacing:.5},{note:64,duration:1.5,spacing:2}],
  believer: [{note:58,duration:.5,spacing:.5},{note:58,duration:.5,spacing:.5},{note:58,duration:.5,spacing:.5},{note:58,duration:1,spacing:1.5},{note:54,duration:.5,spacing:.5},{note:54,duration:.5,spacing:1},{note:53,duration:1.5,spacing:2}],
  starwars: [{note:55,duration:1,spacing:1},{note:55,duration:1,spacing:1},{note:55,duration:1,spacing:1},{note:51,duration:.7,spacing:.8},{note:58,duration:.3,spacing:.4},{note:55,duration:1,spacing:1},{note:51,duration:.7,spacing:.8},{note:58,duration:.3,spacing:.4},{note:55,duration:2,spacing:2.5}],
  elise: [{note:76,duration:.5,spacing:.5},{note:75,duration:.5,spacing:.5},{note:76,duration:.5,spacing:.5},{note:75,duration:.5,spacing:.5},{note:76,duration:.5,spacing:.5},{note:71,duration:.5,spacing:.5},{note:74,duration:.5,spacing:.5},{note:72,duration:.5,spacing:.5},{note:69,duration:1.5,spacing:2}],
  badRomance: [{note:69,duration:.5,spacing:.5},{note:69,duration:.5,spacing:.5},{note:69,duration:.5,spacing:.5},{note:69,duration:1,spacing:1},{note:71,duration:.5,spacing:.5},{note:72,duration:.5,spacing:.5},{note:69,duration:1,spacing:1.5}],
  inTheEnd: [{note:63,duration:1,spacing:1},{note:58,duration:1,spacing:2},{note:58,duration:1,spacing:1},{note:61,duration:1,spacing:1},{note:60,duration:1,spacing:1},{note:58,duration:1,spacing:1},{note:56,duration:1,spacing:1.5}],
  anniversaire: [{note:60,duration:.5,spacing:.5},{note:60,duration:.5,spacing:1},{note:62,duration:1,spacing:1},{note:60,duration:1,spacing:1},{note:65,duration:1,spacing:1},{note:64,duration:2,spacing:2}],
  queen: [{note:58,duration:1,spacing:1},{note:60,duration:.5,spacing:.5},{note:61,duration:.5,spacing:1},{note:63,duration:1,spacing:1.5},{note:61,duration:.5,spacing:.5},{note:60,duration:1.5,spacing:2}],
  bellaCiao: [{note:57,duration:.5,spacing:.5},{note:60,duration:.5,spacing:.5},{note:62,duration:.5,spacing:.5},{note:64,duration:1,spacing:1.2},{note:57,duration:.5,spacing:.5},{note:60,duration:.5,spacing:.5},{note:62,duration:.5,spacing:.5},{note:64,duration:1,spacing:1.5}]
};

/* ========== VARIABLES (identique) ========== */
let notes = [];
let isSong = false;
let isTwoHandCourse = false;
let isPlaying = false;
let currentPartitionData = null;
let originalPartitionData = null;
let score = 0, combo = 0;
function updateEval(){}

/* ========== DROP NOTE (identique) ========== */
let currentTempo = 450;
function drop(noteData){
  const {note, duration, spacing, hand} = noteData;
  const k = document.querySelector(`[data-m="${note}"]`);
  if(!k) return;
  const el = document.createElement('div');
  el.className = 'note';
  const nameSpan = document.createElement('span');
  const noteName = NAMES[note % 12] || '‚ôØ';
  const isBlackKey = [1,3,6,8,10].includes(note % 12);
  if(isBlackKey && SHARP_NAMES[note % 12]){
    nameSpan.innerHTML = `${noteName}<span style="color: #000; font-size: 12px;">#</span>`;
  } else {
    nameSpan.textContent = noteName;
  }
  nameSpan.style.color = '#222'; nameSpan.style.fontSize = '14px'; nameSpan.style.fontWeight = '700'; nameSpan.style.marginTop = '4px';
  el.appendChild(nameSpan);
  const noteColor = isBlackKey ? getSharpFlatColor(note) : (NATURAL_COL[note % 12] || '#888');
  el.style.background = noteColor;
  const baseHeight = 44;
  const height = Math.max(22, baseHeight * duration);
  el.style.height = height + 'px';
  el.style.width = '44px';
  const pianoRect = piano.getBoundingClientRect();
  const fallRect = fallZone.getBoundingClientRect();
  const keyRect = k.getBoundingClientRect();
  const keyCenter = keyRect.left + keyRect.width / 2;
  const fallLeft = fallRect.left;
  el.style.left = (keyCenter - fallLeft) + 'px';
  el.style.boxShadow = `0 0 16px 4px ${noteColor}`;
  const handInd = document.createElement('div'); handInd.className = 'hand-indicator'; handInd.textContent = isTwoHandCourse ? (hand === 'left' ? 'G' : 'D') : ''; el.appendChild(handInd);
  const durInd = document.createElement('div'); durInd.style.fontSize = '8px'; durInd.style.marginTop = '2px'; durInd.textContent = duration.toFixed(2); el.appendChild(durInd);
  fallZone.appendChild(el);
  const o = {note, el, y: -height, ok: false, duration, spacing, hand, active: false, played: false};
  notes.push(o);
  function step(){
    const linePos = fallZone.clientHeight - 120;
    const stopThreshold = linePos - height;
    if(!o.played && o.y >= stopThreshold && o.y <= stopThreshold + 10){
      o.played = true;
      if(isSong && !microListening){playNote(o.note, o.duration);}
    }
    o.y += (600 / currentTempo) * 2;
    if(!o.ok && !isSong && o.y >= stopThreshold){
      o.y = stopThreshold;
      el.classList.add('waiting');
    } else {
      el.classList.remove('waiting');
    }
    el.style.top = o.y + 'px';
    if(o.y > fallZone.clientHeight){
      if(!o.ok){combo = 0;}
      el.remove();
      notes = notes.filter(x => x !== o);
      return;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ========== S√âQUENCE (identique) ========== */
let sequenceController = null;
let currentPartition = null;
function startSequence(partition){
  let seq = niveaux[partition] || chansons[partition] || niveaux.facile1.map(normalizeNoteData);
  isSong = !!chansons[partition];
  isTwoHandCourse = ['facile1','facile2','facile3'].includes(partition);
  isPlaying = true;
  currentPartitionData = JSON.parse(JSON.stringify(seq));
  originalPartitionData = JSON.parse(JSON.stringify(seq));
  buildScoreStrip(seq);
  currentScoreIndex = 0;
  sequenceController = {notes: seq, index: 0, isActive: true, isPaused: false, timeout: null};
  playNextNote();
}
function playNextNote(){
  if(!sequenceController || !sequenceController.isActive) return;
  if(sequenceController.index >= sequenceController.notes.length){setTimeout(() => stopBtn.onclick(), 500); return;}
  if(sequenceController.isPaused){setTimeout(playNextNote, 50); return;}
  const currentNote = sequenceController.notes[sequenceController.index];
  drop(currentNote);
  updateScoreStrip(sequenceController.index);
  const delay = currentTempo * currentNote.duration * (currentNote.spacing || 1.0);
  sequenceController.index++;
  if(!isSong){sequenceController.isPaused = true;}
  if(isSong && sequenceController.index < sequenceController.notes.length){sequenceController.timeout = setTimeout(playNextNote, delay);}
}

/* ========== √âDITEUR TIMING (identique) ========== */
const editTimingBtn = document.getElementById('editTimingBtn');
const noteTimingEditor = document.getElementById('noteTimingEditor');
const timingList = document.getElementById('timingList');
const saveTimingBtn = document.getElementById('saveTimingBtn');
const cancelTimingBtn = document.getElementById('cancelTimingBtn');
function showTimingEditor() {
  if(!currentPartitionData){alert('Aucune partition s√©lectionn√©e !'); return;}
  timingList.innerHTML = '';
  currentPartitionData.forEach((noteData, index) => {
    const timingItem = document.createElement('div'); timingItem.className = 'timingItem';
    const noteName = NAMES[noteData.note % 12] || '‚ôØ';
    const octave = Math.floor(noteData.note / 12) - 1;
    timingItem.innerHTML = `<label>Note ${index + 1}: ${noteName}${octave}</label><input type="range" min="0.3" max="2.5" step="0.1" value="${noteData.spacing || 1.0}" data-index="${index}"><span class="timingValue">${(noteData.spacing || 1.0).toFixed(1)}x</span>`;
    const slider = timingItem.querySelector('input[type="range"]');
    const valueDisplay = timingItem.querySelector('.timingValue');
    slider.addEventListener('input', (e) => {
      const newValue = parseFloat(e.target.value);
      valueDisplay.textContent = newValue.toFixed(1) + 'x';
      currentPartitionData[index].spacing = newValue;
    });
    timingList.appendChild(timingItem);
  });
  noteTimingEditor.style.display = 'block';
}
function hideTimingEditor() { noteTimingEditor.style.display = 'none'; }
function saveTimingChanges() {
  if(currentPartition && (niveaux[currentPartition] || chansons[currentPartition])) {
    const partitionRef = niveaux[currentPartition] || chansons[currentPartition];
    for(let i = 0; i < currentPartitionData.length; i++) partitionRef[i] = currentPartitionData[i];
    console.log('Timing sauvegard√© !');
  }
  hideTimingEditor();
}
function cancelTimingChanges() {
  currentPartitionData = JSON.parse(JSON.stringify(originalPartitionData));
  hideTimingEditor();
}
editTimingBtn.addEventListener('click', showTimingEditor);
saveTimingBtn.addEventListener('click', saveTimingChanges);
cancelTimingBtn.addEventListener('click', cancelTimingChanges);

/* ========== CONTR√îLES (identique) ========== */
document.getElementById('modeSelect').onchange = (e) => {
  if(e.target.value === 'profile_management') {
    showProfileModal();
    e.target.value = '';
    return;
  }
  currentPartition = e.target.value;
};

/* ========== CLAVIER : üéØ FIX TACTILE üéØ ========== */
function handleKeyPress(m){
  console.log(`Touche press√©e: ${m} (${NAMES[m%12]})`);
  playSound(m); flash(m);
  if(isSong){
    notes.forEach(x => {if(!x.ok && x.note === m){x.ok = true; score++; combo++;}});
  } else {
    const waitingNotes = notes.filter(n => !n.ok);
    if(waitingNotes.length > 0){
      const linePos = fallZone.clientHeight - 120;
      let closestNote = null; let minDistance = Infinity;
      waitingNotes.forEach(note => {
        const noteBottom = note.y + note.el.offsetHeight;
        const distance = Math.abs(noteBottom - linePos);
        if(distance < minDistance){minDistance = distance; closestNote = note;}
      });
      if(closestNote && closestNote.note === m){
        closestNote.ok = true; score++; combo++;
        currentScoreIndex++;
        if(currentScoreIndex < scoreNotes.length) {updateScoreStrip(currentScoreIndex);}
        if(sequenceController && sequenceController.isPaused){sequenceController.isPaused = false; setTimeout(playNextNote, 50);}
      } else {
        combo = 0;
        console.log(`Mauvaise note: ${m} (attendu: ${closestNote ? closestNote.note : 'aucune'})`);
      }
    } else {
      console.log(`Aucune note n'attend - note jou√©e: ${m}`);
    }
  }
}
function flash(m){
  const k = document.querySelector(`[data-m="${m}"]`);
  if(!k) return;
  k.style.filter = 'brightness(1.4)';
  setTimeout(() => k.style.filter = '', 150);
}

/* üéØ FIX PRINCIPAL : Gestionnaire tactile pour le piano */
function handlePianoTouch(e) {
  e.preventDefault(); // Emp√™che le scroll/zoom
  const touch = e.changedTouches ? e.changedTouches[0] : e; // G√®re touch et mouse
  const element = document.elementFromPoint(touch.clientX, touch.clientY);
  const k = element.closest('.key');
  if(!k) return;
  const m = +k.dataset.m;
  handleKeyPress(m);
}

// Ajoute les deux √©v√©nements pour compatibilit√© souris/tactile
piano.addEventListener('touchstart', handlePianoTouch, { passive: false });
piano.addEventListener('mousedown', handlePianoTouch);

/* ========== SPEED + BOUTONS (identique) ========== */
const speedBox = document.getElementById('speedBox');
speedBox.addEventListener('click', e => {
  const btn = e.target.closest('.speedBtn');
  if(!btn) return;
  document.querySelectorAll('.speedBtn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentTempo = +btn.dataset.ms;
});

/* ========== MICRO (identique) ========== */
const microBtn = document.getElementById('microBtn');
let microListening = false, audioStream = null, microAudioContext = null, analyser = null, dataArray = null, rafId = null;
async function startSilentMicroAnalysis() {
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: false,
        sampleRate: 22050,
        channelCount: 1,
        latency: 0.02
      }
    });
    microAudioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 22050, latencyHint: 'interactive' });
    if(microAudioContext.state === 'suspended') {await microAudioContext.resume();}
    analyser = microAudioContext.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.9;
    analyser.minDecibels = -80;
    analyser.maxDecibels = -10;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    const source = microAudioContext.createMediaStreamSource(audioStream);
    source.connect(analyser);
    microListening = true;
    microBtn.classList.add('listening');
    microBtn.textContent = 'Arr√™ter Micro';
    silentAnalysisLoop();
  } catch (err) {
    console.error('Micro erreur:', err);
    microBtn.textContent = '√âcouter Micro';
    alert('Micro impossible : ' + err.message);
  }
}
function silentAnalysisLoop() {
  if(!microListening || !analyser || !dataArray) return;
  analyser.getByteFrequencyData(dataArray);
  let totalEnergy = 0, peakAmplitude = 0, peakBin = 0;
  const minBin = Math.floor(80 * dataArray.length / microAudioContext.sampleRate);
  const maxBin = Math.floor(1500 * dataArray.length / microAudioContext.sampleRate);
  for(let i = minBin; i < maxBin && i < dataArray.length; i++) {
    totalEnergy += dataArray[i];
    if(dataArray[i] > peakAmplitude) {peakAmplitude = dataArray[i]; peakBin = i;}
  }
  const avgEnergy = totalEnergy / (maxBin - minBin);
  const detectionThreshold = Math.max(60, avgEnergy * 2.5);
  if(peakAmplitude > detectionThreshold && peakAmplitude > 70) {
    const peakFrequency = (peakBin * microAudioContext.sampleRate) / (2 * dataArray.length);
    const note = Math.round(69 + 12 * Math.log2(peakFrequency / 440));
    if(note >= START && note <= END) {
      console.log(`NOTE D√âTECT√âE: ${note} (${peakFrequency.toFixed(1)}Hz)`);
      setTimeout(() => {if(microListening) handleKeyPress(note);}, 150);
      setTimeout(() => {if(microListening) rafId = requestAnimationFrame(silentAnalysisLoop);}, 300);
      return;
    }
  }
  if(microListening) {rafId = requestAnimationFrame(silentAnalysisLoop);}
}
function stopSilentAnalysis() {
  microListening = false;
  if(rafId){cancelAnimationFrame(rafId); rafId = null;}
  if(analyser){analyser.disconnect();}
  if(audioStream){audioStream.getTracks().forEach(track => track.stop());}
  if(microAudioContext && microAudioContext.state !== 'closed'){microAudioContext.suspend();}
  microBtn.classList.remove('listening');
  microBtn.textContent = '√âcouter Micro';
}
microBtn.addEventListener('click', async () => {
  if(microListening){stopSilentAnalysis();} else {await startSilentMicroAnalysis();}
});

/* ========== FEUX D'ARTIFICE (identique) ========== */
function showCongrats(){
  // ... (garde le code complet des feux d'artifice) ...
  if(currentUser){
    const p = loadProfiles();
    if(score > (p[currentUser].best || 0)){p[currentUser].best = score; saveProfiles(p);}
  }
  const fw = document.getElementById('fireworks');
  fw.style.display = 'block'; fw.innerHTML = '';
  const colors = ['#0ff', '#ff0', '#f0f', '#0f0', '#f00', '#fff', '#fa0'];
  const particlesPerBurst = 60; const bursts = 5;
  for(let b = 0; b < bursts; b++){
    setTimeout(() => {
      const x = Math.random() * 100; const y = Math.random() * 60 + 20; const color = colors[Math.floor(Math.random() * colors.length)];
      for(let i = 0; i < particlesPerBurst; i++){
        const p = document.createElement('div'); p.className = 'particle'; p.style.background = color;
        p.style.left = x + '%'; p.style.top = y + '%';
        const angle = (Math.PI * 2 * i) / particlesPerBurst; const dist = Math.random() * 150 + 50;
        p.style.setProperty('--dx', `${Math.cos(angle) * dist}px`); p.style.setProperty('--dy', `${Math.sin(angle) * dist}px`);
        p.style.animationDelay = (Math.random() * 0.2) + 's'; fw.appendChild(p);
      }
    }, b * 300);
  }
  fw.onclick = () => {fw.style.display = 'none'; fw.innerHTML = ''; document.getElementById('modeSelect').value = ''; currentPartition = null; score = 0; combo = 0;};
}

/* ========== AUDIO CHANSONS (identique) ========== */
let songAudioCtx = null;
function initSongAudio(){if(!songAudioCtx){songAudioCtx = new (window.AudioContext || window.webkitAudioContext)();}}
function playNote(midiNote, duration){
  if(!isPlaying || !isSong || microListening) return;
  if(!songAudioCtx) initSongAudio();
  if(songAudioCtx.state === 'suspended') songAudioCtx.resume();
  const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
  const osc = songAudioCtx.createOscillator();
  const gain = songAudioCtx.createGain();
  osc.type = 'triangle'; osc.frequency.value = frequency;
  const now = songAudioCtx.currentTime;
  const attack = 0.01, sustain = Math.max(0.1, duration * 0.7), release = Math.max(0.05, duration * 0.3);
  gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + attack);
  gain.gain.exponentialRampToValueAtTime(0.2, now + attack + sustain);
  gain.gain.exponentialRampToValueAtTime(0.001, now + attack + sustain + release);
  osc.connect(gain); gain.connect(songAudioCtx.destination);
  osc.start(now); osc.stop(now + attack + sustain + release + 0.05);
}

/* ========== UNLOCK AUDIO (identique) ========== */
const startScreen = document.getElementById('startScreen');
function unlockAudio() {
  if(!audioCtx) initAudio();
  if(audioCtx.state === 'suspended') audioCtx.resume();
  if(songAudioCtx && songAudioCtx.state === 'suspended') songAudioCtx.resume();
  startScreen.style.display = 'none';
  document.removeEventListener('touchstart', unlockAudio);
  document.removeEventListener('click', unlockAudio);
}
document.addEventListener('touchstart', unlockAudio, {once: true});
document.addEventListener('click', unlockAudio, {once: true});

/* ========== INIT (identique) ========== */
updateEval();
console.log('PianoKid Evo - Version mobile tactile');
</script>
</body>
</html>
